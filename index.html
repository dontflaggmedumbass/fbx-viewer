<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Link-Lock Encrypter</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; max-width: 600px; margin: auto; }
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        .alert { margin-top: 10px; font-weight: bold; color: #d9534f; opacity: 0; transition: opacity 0.3s; }
    </style>
</head>
<body>

    <h2>Link-Lock Encrypter</h2>
    
    <label>URL / Secret Text to Hide:</label>
    <textarea id="output" placeholder="https://example.com"></textarea>

    <label>Password:</label>
    <input type="password" id="password" placeholder="Enter a strong password">

    <button onclick="onEncrypt()">Generate Encrypted Link</button>

    <hr>

    <label>Resulting Encrypted URL:</label>
    <input type="text" id="encrypted-url" readonly onclick="this.select()">
    
    <div class="alert" id="status-message"></div>

    <script>
        /*******************************************************************************
         * Base64 & Binary Helpers (The "b64" Library)
         ******************************************************************************/
        const b64 = {
            decode: (str) => atob(str.replace(/-/g, "+").replace(/_/g, "/")),
            encode: (str) => btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, ""),
            asciiToBinary: (str) => new TextEncoder().encode(str),
            binaryToAscii: (bin) => new TextDecoder().decode(bin),
            binaryToBase64: (bin) => btoa(String.fromCharCode(...bin)),
            base64ToBinary: (str) => Uint8Array.from(atob(str), c => c.charCodeAt(0))
        };

        /*******************************************************************************
         * Encryption API (Logic from Jacob Strieb)
         ******************************************************************************/
        const LATEST_API_VERSION = "0.0.1";
        const apiVersions = {};

        apiVersions["0.0.1"] = {
            // Default Salt/IV if none provided
            salt: Uint8Array.from([236, 231, 167, 249, 207, 95, 201, 235, 164, 98, 246, 26, 176, 174, 72, 249]),
            iv: Uint8Array.from([255, 237, 148, 105, 6, 255, 123, 202, 115, 130, 16, 116]),

            randomSalt: () => window.crypto.getRandomValues(new Uint8Array(16)),
            randomIv: () => window.crypto.getRandomValues(new Uint8Array(12)),

            deriveKey: async function(password, salt) {
                let rawKey = await window.crypto.subtle.importKey(
                    "raw", b64.asciiToBinary(password), { name: "PBKDF2" }, false, ["deriveBits", "deriveKey"]
                );
                return await window.crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt: salt || this.salt, iterations: 100000, hash: "SHA-256" },
                    rawKey, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]
                );
            },

            encrypt: async function(text, password, salt, iv) {
                let key = await this.deriveKey(password, salt);
                return await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv || this.iv },
                    key, b64.asciiToBinary(text)
                );
            }
        };

        /*******************************************************************************
         * Main UI Function (The "Reverse" of your Decrypt code)
         ******************************************************************************/
        async function onEncrypt() {
            const status = document.getElementById("status-message");
            const plainText = document.getElementById("output").value;
            const password = document.getElementById("password").value;

            if (!plainText || !password) {
                status.innerText = "Error: Need both text and password!";
                status.style.opacity = 1;
                return;
            }

            try {
                const api = apiVersions[LATEST_API_VERSION];
                const salt = api.randomSalt();
                const iv = api.randomIv();

                // Perform Encryption
                const encryptedBuffer = await api.encrypt(plainText, password, salt, iv);
                
                // Package into the JSON format Link-Lock expects
                const params = {
                    v: LATEST_API_VERSION,
                    e: b64.binaryToBase64(new Uint8Array(encryptedBuffer)),
                    s: b64.binaryToBase64(salt),
                    i: b64.binaryToBase64(iv)
                };

                // Convert to Base64 fragment
                const encodedParams = b64.encode(JSON.stringify(params));
                const finalUrl = `https://jstrieb.github.io/link-lock/#${encodedParams}`;

                document.getElementById("encrypted-url").value = finalUrl;
                status.innerText = "Successfully Encrypted!";
                status.style.opacity = 1;
            } catch (e) {
                status.innerText = "Encryption failed.";
                status.style.opacity = 1;
                console.error(e);
            }
        }
    </script>
</body>
</html>
