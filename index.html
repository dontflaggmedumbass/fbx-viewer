<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Encryption Visualizer</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 800px; margin: auto; background-color: #f4f7f6; }
        .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        textarea, input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: monospace; }
        button { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:hover { background: #218838; }
        .log-window { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; height: 300px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 13px; margin-top: 20px; border-left: 5px solid #007acc; }
        .log-entry { margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .step { color: #569cd6; font-weight: bold; }
        .data { color: #ce9178; word-break: break-all; }
        .highlight { color: #b5cea8; }
    </style>
</head>
<body>

<div class="container">
    <h2>Step-by-Step Encrypter</h2>
    
    <label>1. Content to Hide (URL):</label>
    <textarea id="plainInput" placeholder="Enter URL here...">https://google.com</textarea>

    <label>2. Secret Password:</label>
    <input type="text" id="passInput" placeholder="Password123">

    <button onclick="visualizeEncryption()">Start Encryption Process</button>

    <div class="log-window" id="consoleLog">
        <div class="log-entry">--- Ready to encrypt. Click the button above. ---</div>
    </div>

    <label style="margin-top:20px; display:block;">3. Final Encrypted Link:</label>
    <input type="text" id="finalResult" readonly>
</div>

<script>
    const b64 = {
        encode: (str) => btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, ""),
        asciiToBinary: (str) => new TextEncoder().encode(str),
        binaryToBase64: (bin) => btoa(String.fromCharCode(...bin))
    };

    function log(step, message, data = "") {
        const consoleLog = document.getElementById("consoleLog");
        const entry = document.createElement("div");
        entry.className = "log-entry";
        entry.innerHTML = `<span class="step">[STEP ${step}]</span> ${message} <br> <span class="data">${data}</span>`;
        consoleLog.prepend(entry);
    }

    async function visualizeEncryption() {
        const text = document.getElementById("plainInput").value;
        const password = document.getElementById("passInput").value;
        document.getElementById("consoleLog").innerHTML = ""; // Clear logs

        if (!text || !password) {
            log("!", "ERROR: Missing URL or Password", "");
            return;
        }

        try {
            // STEP 1: SALT GENERATION
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            log(1, "Generated a unique Salt (prevents hackers using pre-computed tables)", b64.binaryToBase64(salt));

            // STEP 2: KEY DERIVATION
            log(2, "Running PBKDF2 algorithm...", "Taking password '" + password + "' and mixing with salt over 100,000 iterations to create a 256-bit key.");
            
            let rawKey = await window.crypto.subtle.importKey(
                "raw", b64.asciiToBinary(password), { name: "PBKDF2" }, false, ["deriveKey"]
            );

            let encryptionKey = await window.crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                rawKey, { name: "AES-GCM", length: 256 }, false, ["encrypt"]
            );
            log(2.1, "Key Derived Successfully", "[Object CryptoKey: Hidden for security]");

            // STEP 3: IV GENERATION
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            log(3, "Generated random IV (Initialization Vector)", b64.binaryToBase64(iv));

            // STEP 4: AES-GCM ENCRYPTION
            log(4, "Encrypting plaintext with AES-GCM...", "Input: " + text);
            const encryptedBuffer = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                encryptionKey, b64.asciiToBinary(text)
            );
            const encryptedBase64 = b64.binaryToBase64(new Uint8Array(encryptedBuffer));
            log(4.1, "Encryption Complete. Scrambled result:", encryptedBase64);

            // STEP 5: PACKAGING
            const params = {
                v: "0.0.1",
                e: encryptedBase64,
                s: b64.binaryToBase64(salt),
                i: b64.binaryToBase64(iv)
            };
            const finalString = JSON.stringify(params);
            log(5, "Bundled all components into a JSON object", finalString);

            // STEP 6: BASE64 URL FRAGMENT
            const hash = b64.encode(finalString);
            const finalLink = "https://jstrieb.github.io/link-lock/#" + hash;
            document.getElementById("finalResult").value = finalLink;
            log(6, "SUCCESS: Final link generated and ready for sharing.", "");

        } catch (e) {
            log("!", "CRITICAL ERROR", e.message);
        }
    }
</script>
</body>
</html>
