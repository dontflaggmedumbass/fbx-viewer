<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>How Encryption Works</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #0d1117; color: #c9d1d9; padding: 20px; line-height: 1.4; }
        .logic-card { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 20px; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        input { background: #0d1117; border: 1px solid #30363d; color: #58a6ff; padding: 8px; width: 100%; box-sizing: border-box; }
        button { background: #238636; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 6px; font-weight: bold; }
        .print-out { white-space: pre-wrap; color: #8b949e; font-size: 13px; }
        .label { color: #f0883e; font-weight: bold; }
        .value { color: #79c0ff; }
        .math { color: #ff7b72; }
    </style>
</head>
<body>

<div class="logic-card">
    <h2>Encryption Logic Printer</h2>
    <div class="input-group">
        <label>Secret URL:</label>
        <input type="text" id="url" value="https://secret.com">
    </div>
    <div class="input-group">
        <label>Password:</label>
        <input type="text" id="pass" value="Password123">
    </div>
    <button onclick="printLogic()">Encrypt & Print Logic</button>
</div>

<div id="output" class="print-out"></div>

<script>
    const b64 = {
        encode: (str) => btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, ""),
        asciiToBinary: (str) => new TextEncoder().encode(str),
        binToHex: (bin) => Array.from(bin).map(b => b.toString(16).padStart(2, '0')).join(' '),
        binaryToBase64: (bin) => btoa(String.fromCharCode(...bin))
    };

    async function printLogic() {
        const out = document.getElementById("output");
        const urlText = document.getElementById("url").value;
        const passText = document.getElementById("pass").value;
        out.innerHTML = "Initializing Encryption Pipeline...\n\n";

        // 1. RAW DATA
        out.innerHTML += `<span class="label">[1] CONVERTING TEXT TO BYTES</span>\n`;
        const urlBytes = b64.asciiToBinary(urlText);
        out.innerHTML += `    Plaintext: "${urlText}"\n`;
        out.innerHTML += `    Raw Bytes (Hex): <span class="value">${b64.binToHex(urlBytes)}</span>\n\n`;

        // 2. PBKDF2
        out.innerHTML += `<span class="label">[2] DERIVING CRYPTO KEY (PBKDF2)</span>\n`;
        const salt = window.crypto.getRandomValues(new Uint8Array(16));
        out.innerHTML += `    Generated Salt: <span class="value">${b64.binToHex(salt)}</span>\n`;
        out.innerHTML += `    <span class="math">Math: PBKDF2(Password + Salt, 100,000 Rounds, SHA-256)</span>\n`;
        
        const rawKey = await window.crypto.subtle.importKey("raw", b64.asciiToBinary(passText), {name:"PBKDF2"}, false, ["deriveKey"]);
        const encryptionKey = await window.crypto.subtle.deriveKey(
            {name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256"},
            rawKey, {name: "AES-GCM", length: 256}, false, ["encrypt"]
        );
        out.innerHTML += `    Result: 256-bit AES Key generated in protected memory.\n\n`;

        // 3. AES-GCM
        out.innerHTML += `<span class="label">[3] PERFORMING AES-GCM ENCRYPTION</span>\n`;
        const iv = window.crypto.getRandomValues(new Uint8Array(12));
        out.innerHTML += `    Initialization Vector (IV): <span class="value">${b64.binToHex(iv)}</span>\n`;
        
        const encryptedBuffer = await window.crypto.subtle.encrypt({name: "AES-GCM", iv: iv}, encryptionKey, urlBytes);
        const ciphertext = new Uint8Array(encryptedBuffer);
        
        out.innerHTML += `    <span class="math">Operation: XOR Cipher + Galois Field Multiplication (for Integrity)</span>\n`;
        out.innerHTML += `    Encrypted Bytes: <span class="value">${b64.binToHex(ciphertext)}</span>\n\n`;

        // 4. PACKAGING
        out.innerHTML += `<span class="label">[4] PACKAGING FOR URL</span>\n`;
        const params = {
            v: "0.0.1",
            e: b64.binaryToBase64(ciphertext),
            s: b64.binaryToBase64(salt),
            i: b64.binaryToBase64(iv)
        };
        const json = JSON.stringify(params);
        out.innerHTML += `    JSON Bundle: ${json}\n`;
        
        const finalHash = b64.encode(json);
        out.innerHTML += `    Final Base64 Hash: <span class="value">${finalHash}</span>\n\n`;
        out.innerHTML += `<span class="label">--- PROCESS COMPLETE ---</span>\n`;
        out.innerHTML += `URL: https://jstrieb.github.io/link-lock/#${finalHash}`;
    }
</script>

</body>
</html>
